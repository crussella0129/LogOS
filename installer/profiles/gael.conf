# LogOS Ringed City Profile: GAEL
# Maximum Security Configuration
# "Slave Knight Gael" - Endured to the literal end of the world

################################################################################
# Profile Metadata
################################################################################

PROFILE_NAME="Gael"
PROFILE_DESCRIPTION="Maximum Security"
PROFILE_KERNEL="linux-lts"
PROFILE_USE_CASE="High-threat environments, border crossings, hostile networks"
PROFILE_PERFORMANCE_IMPACT="High (15-30% overhead)"

################################################################################
# Kernel Selection
################################################################################

# Primary kernel (LTS for stability in security-critical scenarios)
KERNEL_PRIMARY="linux-lts"
KERNEL_PRIMARY_HEADERS="linux-lts-headers"

# Fallback kernel
KERNEL_FALLBACK="linux-hardened"
KERNEL_FALLBACK_HEADERS="linux-hardened-headers"

################################################################################
# Kernel Parameters
################################################################################

KERNEL_PARAMS=(
    # Core security
    "audit=1"
    "apparmor=1"

    # LSM stack
    "lsm=landlock,lockdown,yama,integrity,apparmor,bpf"

    # CPU mitigations (full protection)
    "mitigations=auto,nosmt"

    # Lockdown mode (prevent kernel modifications)
    "lockdown=confidentiality"

    # Disable SMT/Hyperthreading (prevents side-channel attacks)
    "nosmt"

    # Memory protection
    "init_on_alloc=1"
    "init_on_free=1"
    "page_alloc.shuffle=1"

    # Disable legacy features
    "slab_nomerge"
    "mce=0"

    # Module security
    "module.sig_enforce=1"

    # Kernel page-table isolation
    "pti=on"

    # IOMMU isolation
    "iommu=force"
    "iommu.passthrough=0"

    # Randomization
    "randomize_kstack_offset=on"

    # Quiet boot
    "quiet"
    "loglevel=3"
)

################################################################################
# Sysctl Security Parameters
################################################################################

SYSCTL_PARAMS=(
    # Network hardening (aggressive)
    "net.ipv4.tcp_syncookies=1"
    "net.ipv4.conf.all.accept_redirects=0"
    "net.ipv4.conf.default.accept_redirects=0"
    "net.ipv6.conf.all.accept_redirects=0"
    "net.ipv6.conf.default.accept_redirects=0"
    "net.ipv4.conf.all.accept_source_route=0"
    "net.ipv4.conf.default.accept_source_route=0"
    "net.ipv6.conf.all.accept_source_route=0"
    "net.ipv6.conf.default.accept_source_route=0"
    "net.ipv4.conf.all.send_redirects=0"
    "net.ipv4.conf.default.send_redirects=0"
    "net.ipv4.conf.all.rp_filter=1"
    "net.ipv4.conf.default.rp_filter=1"
    "net.ipv4.conf.all.log_martians=1"
    "net.ipv4.conf.default.log_martians=1"
    "net.ipv4.icmp_echo_ignore_broadcasts=1"
    "net.ipv4.icmp_ignore_bogus_error_responses=1"
    "net.ipv4.tcp_timestamps=0"

    # Kernel hardening (maximum)
    "kernel.randomize_va_space=2"
    "kernel.dmesg_restrict=1"
    "kernel.kptr_restrict=2"
    "kernel.perf_event_paranoid=3"
    "kernel.yama.ptrace_scope=3"
    "kernel.unprivileged_bpf_disabled=1"
    "kernel.kexec_load_disabled=1"
    "kernel.unprivileged_userns_clone=0"

    # Filesystem hardening
    "fs.protected_hardlinks=1"
    "fs.protected_symlinks=1"
    "fs.protected_fifos=2"
    "fs.protected_regular=2"
    "fs.suid_dumpable=0"

    # Disable core dumps (prevents information leakage)
    "kernel.core_uses_pid=1"
    "fs.suid_dumpable=0"
)

################################################################################
# Security Services
################################################################################

ENABLE_SERVICES=(
    "apparmor"
    "auditd"
    "ufw"
    "fail2ban"
)

# Additional services to mask/disable
DISABLE_SERVICES=(
    "bluetooth"  # Disable by default (attack surface)
    "cups"       # Disable printing unless needed
)

################################################################################
# Firewall Configuration
################################################################################

UFW_DEFAULT_INCOMING="deny"
UFW_DEFAULT_OUTGOING="allow"
UFW_DEFAULT_FORWARD="deny"
UFW_LOG_LEVEL="high"

# Only essential ports (none by default)
UFW_ALLOW_PORTS=()

################################################################################
# AppArmor Configuration
################################################################################

APPARMOR_MODE="enforce"  # All profiles in enforce mode
APPARMOR_COMPLAIN_PROFILES=()  # No exceptions

################################################################################
# Audit Configuration
################################################################################

AUDIT_BUFFER_SIZE="8192"
AUDIT_FAILURE_MODE="1"  # Print to syslog
AUDIT_LOG_FORMAT="ENRICHED"

# Comprehensive audit rules
AUDIT_RULES=(
    # Monitor identity changes
    "-w /etc/passwd -p wa -k identity"
    "-w /etc/shadow -p wa -k identity"
    "-w /etc/group -p wa -k identity"
    "-w /etc/gshadow -p wa -k identity"
    "-w /etc/sudoers -p wa -k sudoers"
    "-w /etc/sudoers.d -p wa -k sudoers"

    # Monitor system calls
    "-a always,exit -F arch=b64 -S execve -k exec"
    "-a always,exit -F arch=b64 -S open,openat,creat -k file_access"

    # Monitor network
    "-a always,exit -F arch=b64 -S socket,connect,bind,listen,accept -k network"

    # Monitor privileged commands
    "-a always,exit -F path=/usr/bin/sudo -F perm=x -k privileged"
    "-a always,exit -F path=/usr/bin/su -F perm=x -k privileged"

    # Make configuration immutable
    "-e 2"
)

################################################################################
# Power Management
################################################################################

# Conservative power settings for Gael (security over performance)
CPU_GOVERNOR="powersave"
CPU_BOOST="0"
PLATFORM_PROFILE="low-power"

################################################################################
# Additional Hardening
################################################################################

# Disable unnecessary kernel modules
BLACKLIST_MODULES=(
    "bluetooth"
    "btusb"
    "firewire-core"
    "firewire-ohci"
    "firewire-sbp2"
    "thunderbolt"
    "pcspkr"
    "uvcvideo"  # Webcam (enable manually if needed)
)

# Restrict USB devices
USB_AUTHORIZED_DEFAULT="0"  # Require manual authorization

# Secure boot requirement
REQUIRE_SECURE_BOOT="recommended"

################################################################################
# Network Configuration
################################################################################

# Disable IPv6 by default (reduce attack surface)
DISABLE_IPV6="yes"

# MAC address randomization
WIFI_MAC_RANDOMIZATION="always"

# DNS over TLS
USE_DNS_OVER_TLS="yes"

################################################################################
# Notes
################################################################################

# This profile is designed for maximum security in hostile environments.
# Performance impact is significant but acceptable for security-critical operations.
# Not recommended for daily use unless working with sensitive data or in high-risk scenarios.
#
# Typical use cases:
# - Crossing international borders with sensitive data
# - Working on untrusted networks (airports, hotels, cafes)
# - Processing classified or sensitive documents
# - Penetration testing in adversarial environments
# - Forensic analysis of compromised systems

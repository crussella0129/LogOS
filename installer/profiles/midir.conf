# LogOS Ringed City Profile: MIDIR
# Balanced Security & Performance Configuration
# "Darkeater Midir" - Raw power tempered by calculated risk

################################################################################
# Profile Metadata
################################################################################

PROFILE_NAME="Midir"
PROFILE_DESCRIPTION="Balanced Daily Driver"
PROFILE_KERNEL="linux-zen"
PROFILE_USE_CASE="Daily secure operations, general workstation use"
PROFILE_PERFORMANCE_IMPACT="Low (2-5% overhead)"

################################################################################
# Kernel Selection
################################################################################

# Primary kernel (Zen for optimized performance with security)
KERNEL_PRIMARY="linux-zen"
KERNEL_PRIMARY_HEADERS="linux-zen-headers"

# Fallback kernel
KERNEL_FALLBACK="linux"
KERNEL_FALLBACK_HEADERS="linux-headers"

################################################################################
# Kernel Parameters
################################################################################

KERNEL_PARAMS=(
    # Core security
    "audit=1"
    "apparmor=1"

    # LSM stack
    "lsm=landlock,lockdown,yama,integrity,apparmor,bpf"

    # CPU mitigations (automatic - balanced)
    "mitigations=auto"

    # Memory protection (basic)
    "init_on_alloc=1"
    "page_alloc.shuffle=1"

    # Module security
    "module.sig_enforce=1"

    # Kernel page-table isolation (auto)
    "pti=auto"

    # IOMMU (performance mode)
    "iommu.passthrough=0"

    # Quiet boot
    "quiet"
    "loglevel=3"
)

################################################################################
# Sysctl Security Parameters
################################################################################

SYSCTL_PARAMS=(
    # Network hardening (balanced)
    "net.ipv4.tcp_syncookies=1"
    "net.ipv4.conf.all.accept_redirects=0"
    "net.ipv6.conf.all.accept_redirects=0"
    "net.ipv4.conf.all.accept_source_route=0"
    "net.ipv6.conf.all.accept_source_route=0"
    "net.ipv4.conf.all.send_redirects=0"
    "net.ipv4.conf.all.rp_filter=1"
    "net.ipv4.conf.all.log_martians=1"
    "net.ipv4.icmp_echo_ignore_broadcasts=1"
    "net.ipv4.icmp_ignore_bogus_error_responses=1"

    # Kernel hardening (balanced)
    "kernel.randomize_va_space=2"
    "kernel.dmesg_restrict=1"
    "kernel.kptr_restrict=2"
    "kernel.perf_event_paranoid=3"
    "kernel.yama.ptrace_scope=2"
    "kernel.unprivileged_bpf_disabled=1"

    # Filesystem hardening
    "fs.protected_hardlinks=1"
    "fs.protected_symlinks=1"
    "fs.protected_fifos=1"
    "fs.protected_regular=1"
    "fs.suid_dumpable=0"

    # Allow core dumps for debugging
    "kernel.core_pattern=|/usr/lib/systemd/systemd-coredump %P %u %g %s %t %c %h"
)

################################################################################
# Security Services
################################################################################

ENABLE_SERVICES=(
    "apparmor"
    "auditd"
    "ufw"
    "fail2ban"
)

# Services available but not forced disabled
DISABLE_SERVICES=()

################################################################################
# Firewall Configuration
################################################################################

UFW_DEFAULT_INCOMING="deny"
UFW_DEFAULT_OUTGOING="allow"
UFW_DEFAULT_FORWARD="deny"
UFW_LOG_LEVEL="low"

# Common ports (can be enabled as needed)
UFW_ALLOW_PORTS=()  # User configures as needed

################################################################################
# AppArmor Configuration
################################################################################

APPARMOR_MODE="enforce"  # Enforce by default

# Allow complain mode for specific profiles if needed
APPARMOR_COMPLAIN_PROFILES=(
    # Can be populated per-user needs
)

################################################################################
# Audit Configuration
################################################################################

AUDIT_BUFFER_SIZE="8192"
AUDIT_FAILURE_MODE="1"
AUDIT_LOG_FORMAT="ENRICHED"

# Balanced audit rules (security-relevant events)
AUDIT_RULES=(
    # Monitor identity changes
    "-w /etc/passwd -p wa -k identity"
    "-w /etc/shadow -p wa -k identity"
    "-w /etc/sudoers -p wa -k sudoers"
    "-w /etc/sudoers.d -p wa -k sudoers"

    # Monitor privileged execution
    "-a always,exit -F arch=b64 -S execve -k exec"

    # Monitor privileged commands
    "-a always,exit -F path=/usr/bin/sudo -F perm=x -k privileged"

    # Make configuration immutable
    "-e 2"
)

################################################################################
# Power Management
################################################################################

# Balanced power settings (adapt to AC/battery)
CPU_GOVERNOR="schedutil"
CPU_BOOST="1"
PLATFORM_PROFILE="balanced"

################################################################################
# Additional Hardening
################################################################################

# Minimal module blacklist (only truly unnecessary)
BLACKLIST_MODULES=(
    "pcspkr"  # PC speaker (annoying beep)
)

# USB devices allowed
USB_AUTHORIZED_DEFAULT="1"

# Secure boot optional
REQUIRE_SECURE_BOOT="optional"

################################################################################
# Network Configuration
################################################################################

# Enable IPv6
DISABLE_IPV6="no"

# MAC address randomization for WiFi
WIFI_MAC_RANDOMIZATION="yes"

# DNS over TLS recommended but not forced
USE_DNS_OVER_TLS="optional"

################################################################################
# Desktop Integration
################################################################################

# Optimize for desktop usage
DESKTOP_OPTIMIZED="yes"

# Allow user applications
ALLOW_FLATPAK="yes"
ALLOW_APPIMAGE="yes"

################################################################################
# Notes
################################################################################

# Midir is the recommended profile for daily use.
# Provides strong security without sacrificing usability or performance.
# Suitable for:
# - Daily workstation use
# - Development work
# - General productivity
# - Home office environments
# - Trusted networks with occasional travel
#
# Performance impact is minimal while maintaining robust security posture.
# This is the default profile for new LogOS installations.
